<div class="json-viewer-container">
  <!-- Header -->
  <div class="header-section">
    <h1>JSON Editor & Viewer</h1>
    <label for="jsonFile" class="file-upload-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      Upload JSON
    </label>
    <input 
      type="file" 
      id="jsonFile"
      accept=".json"
      (change)="onFileSelect($event)"
      class="file-input"
      style="display: none;"
    />
  </div>

  <!-- Success Message -->
  @if (successMessage()) {
    <div class="success-message">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      {{ successMessage() }}
    </div>
  }

  <!-- Main Content Area -->
  @if (displayLines().length === 0 && !isEditMode()) {
    <!-- Empty State: Textarea for pasting -->
    <textarea 
      class="json-input-textarea"
      placeholder="Upload a JSON file or paste JSON content here..."
      (input)="onTextareaInput($event)"
      [value]="textareaContent()"
      spellcheck="false"
    ></textarea>
  }

  <!-- JSON Content Section -->
  @if (displayLines().length > 0 || isEditMode()) {
    <div class="content-header">
      <h2>JSON Content</h2>
      <div class="header-actions">
        <button 
          class="action-btn edit-btn"
          (click)="toggleEditMode()"
          [class.active]="isEditMode()"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          {{ isEditMode() ? 'Cancel Edit' : 'Edit JSON' }}
        </button>

        @if (isEditMode()) {
          <button 
            class="action-btn save-btn"
            (click)="validateAndSave()"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Validate & Save
          </button>

          <button 
            class="action-btn format-btn"
            (click)="formatJson()"
            [disabled]="!isValidJson()"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 3 21 3 21 8"></polyline>
              <line x1="4" y1="20" x2="21" y2="3"></line>
            </svg>
            Format JSON
          </button>
        }

        @if (!isEditMode()) {
          <button 
            class="action-btn download-btn"
            (click)="downloadJson()"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download JSON
          </button>
        }
      </div>
    </div>

    <!-- Validation Error -->
    @if (validationError()) {
      <div class="validation-error">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        {{ validationError() }}
      </div>
    }

    <!-- Expand/Collapse All Buttons -->
    <div class="collapse-controls">
      <button class="control-btn" (click)="expandAll()">Expand All</button>
      <button class="control-btn" (click)="collapseAll()">Collapse All</button>
    </div>

    <!-- Textarea-based Viewer/Editor -->
    <div class="textarea-wrapper">
      @if (isEditMode()) {
        <!-- Editable Textarea with Line Numbers Overlay -->
        <div class="edit-container">
          <!-- Line Numbers and Toggle Icons -->
          <div class="edit-sidebar">
            @for (line of editLines(); track line.id; let i = $index) {
              <div class="edit-line-row">
                <span class="edit-line-number">{{ line.lineNumber }}</span>
                @if (line.hasToggle) {
                  <span 
                    class="edit-toggle-icon"
                    (click)="toggleEditCollapse(line.id)"
                  >
                    {{ line.isCollapsed ? '▶' : '▼' }}
                  </span>
                } @else {
                  <span class="edit-toggle-placeholder"></span>
                }
              </div>
            }
          </div>
          
          <!-- Editable Textarea -->
          <textarea
            class="edit-textarea"
            [value]="getEditableText()"
            (input)="onEditTextareaChange($event)"
            (keydown)="onEditKeyDown($event)"
            (scroll)="onEditScroll($event)"
            spellcheck="false"
          ></textarea>
        </div>
      } @else {
        <!-- Read-only Viewer with Line Numbers and Collapse -->
        <div class="textarea-viewer">
          @for (line of displayLines(); track line.id; let i = $index) {
            <div class="textarea-line">
              <!-- Line Number -->
              <div class="textarea-line-number">{{ line.lineNumber }}</div>
              
              <!-- Content -->
              <div class="textarea-line-content">
                <!-- Toggle Icon -->
                @if (line.hasToggle) {
                  <span 
                    class="textarea-toggle-icon"
                    (click)="toggleCollapse(line.id)"
                  >
                    {{ getToggleIcon(line) }}
                  </span>
                } @else {
                  <span class="textarea-toggle-placeholder"></span>
                }
                
                <!-- Plain Text Content -->
                <span class="textarea-json-content">{{ getPlainTextContent(line) }}</span>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
